<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NBA</title>

  <!-- Vega, Vega-Lite & Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <!-- Styling -->
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <!-- NBA-style Header -->
  <header class="nba-topbar">
    <div class="nba-logo-text">
      <img src="logo-nba.svg" alt="NBA Logo" class="nba-logo">
    </div>

    <div class="project-title">
      <h1>The NBA Universe: Movement, Mastery & Myth</h1>
    </div>
  </header>

<!-- Add this wrapper -->
  <div class="main-content">

    <section class="scene origins">
      <div class="scene-header">
        <h1>Origins of Greatness</h1>
        <p>From the streets of Chicago to the beaches of LA — discover how birthplace shapes basketball’s geography...</p>
      </div>

      <div class="map-container">
        <div id="choropleth_map"></div>
      </div>
    </section>

  </div> <!-- end .main-content -->

  <div class="main-content">
    <hr class="section-divider">

    <h2>Top 20 NBA Legends Skill Radar</h2>
    <p>Select a legend to view their normalized per-game stats (2P, 3P, assists, rebounds, blocks, steals).</p>

    <div class="player-section-grid">
      <div class="player-card">
        <img id="photo" alt="Selected player portrait" hidden>
        <h3 id="player-name">Player</h3>
      </div>

      <div class="player-stats">
        <h2>Player Stats</h2>
        <ul id="stats-list">
          <li>2P: —</li>
          <li>3P: —</li>
          <li>AST: —</li>
          <li>TRB: —</li>
          <li>BLK: —</li>
          <li>STL: —</li>
        </ul>
      </div>

      <div class="radar-panel">
        <div id="radar_chart"></div>
      </div>

      <div class="selector-panel">
        <label for="player-select"><strong>Select Players</strong></label>
        <select id="player-select" multiple size="10"></select>
        <p class="selector-hint">Hold Ctrl (Windows) or Cmd (Mac) to toggle multiple players.</p>
      </div>
    </div>

    <hr class="section-divider">
  </div> <!-- end .main-content -->

  <h2>NBA Shot Chart</h2>
  <p>Shot chart for selected player.</p>
  <div id="shot_chart"></div>

  <hr class="section-divider">

  <h2>3-Point Revolution by Decade</h2>
  <p>League total 3-point attempts (blue) and average accuracy (red), faceted by decade.</p>
  <div id="threept_decades"></div>

  <hr class="section-divider">

  <h2>Game Momentum Stream</h2>
  <p>Smoothed streamgraph of score differential over game time for selected matches.</p>
  <div id="momentum_graph"></div>

  <hr class="section-divider">

  <h2>NBA Dynasty Waffle Chart</h2>
  <p>Waffle chart showing championship wins by team dynasty.</p>
  <div id="dynasty_waffle"></div>

  <script type="module">
    try {
      // Load choropleth
      await vegaEmbed('#choropleth_map', 'js/choropleth_map.vg.json', { actions: false });

      // Load radar chart
      const radarResult = await vegaEmbed('#radar_chart', 'js/top_players_radar.vg.json', { actions: false });
      const radarView = radarResult.view;

  // Load a jointplot-style scatter with court background (MJ 1996-97)
  await vegaEmbed('#shot_chart', 'js/shot_scatter_joint.vg.json', { actions: false });

      // Load 3-point decades chart
      await vegaEmbed('#threept_decades', 'js/threept_decades.vg.json', { actions: false });

  // Load momentum streamgraph
  await vegaEmbed('#momentum_graph', 'js/nba_momentum_stream.vg.json', { actions: false });

  // Load dynasty waffle chart
  await vegaEmbed('#dynasty_waffle', 'js/nba_dynasty_waffle.vg.json', { actions: false });

      // --- Dropdown setup ---
      const playerSelect = document.getElementById('player-select');
      const playerNameEl = document.getElementById("player-name");
      const photoEl = document.getElementById("photo");
      const statsList = document.getElementById("stats-list");
      const defaultStatsHtml = ["2P","3P","AST","TRB","BLK","STL"].map(attr => `<li>${attr}: —</li>`).join("");

      const resetPlayerCard = () => {
        playerNameEl.textContent = "Player";
        photoEl.removeAttribute("src");
        photoEl.hidden = true;
        statsList.innerHTML = defaultStatsHtml;
      };

      resetPlayerCard();
      const playerNames = [
        'Bill Russell','Charles Barkley','Eddie Johnson','Elvin Hayes','Hakeem Olajuwon',
        'Jason Kidd','John Stockton','Kareem Abdul-Jabbar','Karl Malone','Kevin Garnett',
        'Kobe Bryant','LeBron James','Michael Jordan','Moses Malone','Patrick Ewing',
        'Robert Parish','Shaquille O\'Neal','Tim Duncan','Walt Bellamy','Wilt Chamberlain'
      ];

      const playerIDs = {
        "LeBron James": 2544,
        "Michael Jordan": 893,
        "Kobe Bryant": 977,
        "Tim Duncan": 1495,
        "Wilt Chamberlain": 76375,
        "Shaquille O'Neal": 406,
        "Kareem Abdul-Jabbar": 76003,
        "Karl Malone": 252,
        "Kevin Garnett": 708,
        "Hakeem Olajuwon": 165,
        "Bill Russell": 78049,
        "Charles Barkley": 787,
        "Jason Kidd": 467,
        "John Stockton": 304,
        "Patrick Ewing": 121,
        "Moses Malone": 77449,
        "Robert Parish": 305,
        "Elvin Hayes": 76979,
        "Walt Bellamy": 76144,
        "Eddie Johnson": 698
      };

      const getPlayerImage = (name) => {
        const id = playerIDs[name];
        return id
          ? `https://cdn.nba.com/headshots/nba/latest/1040x760/${id}.png`
          : "images/default.jpg";
      };

      const statOrder = ["2P","3P","AST","TRB","BLK","STL"];
      const playerStats = new Map();

      const loadPlayerStats = async () => {
        const response = await fetch("data/top20_players_radar.csv");
        const csv = await response.text();
        const lines = csv.trim().split(/\r?\n/).slice(1);
        for (const line of lines) {
          if (!line) continue;
          const parts = line.split(",");
          if (parts.length < 3) continue;
          const player = parts[0].trim().replaceAll("*", "");
          const metric = parts[1].trim();
          const rawValue = parts[2].trim();
          const numeric = Number(rawValue);
          if (!playerStats.has(player)) {
            playerStats.set(player, {});
          }
          playerStats.get(player)[metric] = Number.isFinite(numeric) ? numeric : rawValue;
        }
      };

      await loadPlayerStats();

      for (const name of playerNames) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        option.selected = false;
        playerSelect.appendChild(option);
      }

      if (playerSelect.options.length) {
        playerSelect.options[0].selected = true;
      }

      const applySelection = (player) => {
        if (!player) {
          resetPlayerCard();
          return;
        }

        playerNameEl.textContent = player;
        const imageSrc = getPlayerImage(player);
        photoEl.src = imageSrc;
        photoEl.hidden = false;

        const stats = playerStats.get(player) || {};
        statsList.innerHTML = statOrder
          .map(attr => {
            const value = stats[attr];
            const display = typeof value === "number"
              ? value.toLocaleString(undefined, { maximumFractionDigits: 2 })
              : value || "—";
            return `<li>${attr}: ${display}</li>`;
          })
          .join("");
      };

      const updateSelection = () => {
        const selected = Array.from(playerSelect.selectedOptions).map(opt => opt.value);
        let values = selected;
        if (!values.length && playerSelect.options[0]) {
          values = [playerSelect.options[0].value];
        }
        for (const option of playerSelect.options) {
          option.selected = values.includes(option.value);
        }
        radarView.signal('selectedPlayers', values).runAsync();
        const lastSelected = values.at(-1) ?? null;
        applySelection(lastSelected);
      };

      playerSelect.addEventListener('change', updateSelection);
      const initialPlayer = playerSelect.options[0] ? playerSelect.options[0].value : null;
      if (initialPlayer) {
        radarView.signal('selectedPlayers', [initialPlayer]).runAsync();
        applySelection(initialPlayer);
      }

      // --- Listen to player selection signal from Vega ---
      radarView.addSignalListener("selectedPlayers", (_, value) => {
        const arr = Array.isArray(value) ? value : [value];
        if (!arr.length) {
          resetPlayerCard();
          return;
        }

        const lastSelected = arr.at(-1) ?? null;
        if (!lastSelected) {
          resetPlayerCard();
          return;
        }

        for (const option of playerSelect.options) {
          option.selected = arr.includes(option.value);
        }
        applySelection(lastSelected);
      });

    } catch (err) {
      console.error(err);
    }
  </script>

</body>
</html>
